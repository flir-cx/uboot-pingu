/*
 * Copyright (C) 2016 FLIR Systems.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

#include <common.h>
#include "mipi_common.h"
#include <asm/io.h>
#include <mipi_display.h>
#include <linux/fb.h>
#include <linux/delay.h>
#include "mxc_mipi_dsi.h"
#include "mxcfb_otm1287.h"

#define OTM1287A_MAX_DPHY_CLK					(300)
#define OTM1287A_ONE_DATA_LANE					(0x1)
#define OTM1287A_TWO_DATA_LANE					(0x2)
#define OTM1287A_CMD_SWRESET					(0x1)
#define OTM1287A_CMD_SLPOUT						(0x11)
#define OTM1287A_CMD_DISPON						(0x29)
#define OTM1287A_REG_MADCTL						(0x36)

/* to write parameters 1 2 3 4 to reg 0x5566
	fill in following struct
	{0x6600,5,{0x55,0x1,0x2,0x3,0x4}
*/

struct reg_value {
    u32	address_shift;
    u32 buf_size;
	u8	buf[24];
};

static struct reg_value lcd_setup[] =
{
	{0x0000,4,{0xff,0x12,0x87,0x1}	},						//Enable Access Command 2 and Software EXTC Enable
	{0x8000,3,{0xff,0x12,0x87}},							//Enable Access Orise Command 2
#if 0 // FLIR
	{0x9000,9,{0xf6,0x12,0x00,0x00,0x00,0xff,0xff,0xff,0x0f}},//Enable Test pattern
#endif

	{0x8000,10,{0xc0, 0x00, 0x64, 0x00, 0x10, 0x10, 0x00, 0x64, 0x10, 0x10}},//RTN setting : line rate or FP / BP setting
	{0x9000,7,{0xc0, 0x00, 0x5C, 0x00, 0x01, 0x00, 0x04}},	//MCLK_clr shift 1~3 number
	{0xb300,3,{0xc0, 0x00, 0x55}},							//Interval Scan Frame
	{0x8000,3,{0xc1, 0x15, 0x11}},							//OSC setting : 60Hz
	{0xa200,4,{0xc1, 0x3f, 0x00, 0x3f}},					//Monitor VS / HS setting
	{0xa000,15,{0xc4, 0x05, 0x10, 0x06, 0x02, 0x05, 0x15, 0x10, 0x05, 0x10, 0x07, 0x02, 0x05, 0x15, 0x10}},	   //dcdc setting
	{0xb000,3,{0xc4, 0x00, 0x00}},							//clamp voltage setting
	{0x9100,3,{0xc5, 0x96, 0x42}},							//VGH/VGL voltage setting : [49h = +16V/-12V]
	{0x0000,3,{0xd8, 0xda, 0xda}},							//GVDD/NGVDD : [B6h B6h = +5.2V -5.2V]
	{0x0000,2,{0xd9,0x73}},									//VCOM voltage setting
	{0xb300,2,{0xc5,0x90}},									//VDD_18 & LVDSVDD setting
	{0xbb00,2,{0xc5,0x8a}},									//LVD voltage level setting
	{0x8200,2,{0xc4,0x0a}},									//chopper
	{0xc600,2,{0xb0,0x03}},									//debounce
	{0x9000,5,{0xf5,0x02, 0x11, 0x02, 0x15}	},				//Pump
	{0x9000,2,{0xc5,0x50}},									//pump : [00h = 1.5x / 50h = 2x / a0h = 3x]
	{0x9400,2,{0xc5,0x66}},									//Pump freq. setting :
	{0xb200,3,{0xf5,0x00, 0x00}},							//VGLO1
	{0xb600,3,{0xf5,0x00, 0x00}},							//VGLO2
	{0x9400,3,{0xf5,0x00, 0x00}},							//VCL pump disable
	{0xd200,3,{0xf5,0x06, 0x15}},							//VCL enable
	{0xb400,2,{0xc5,0xcc}},									//VGLO1/2 Pull low setting:d[7] vglo1 d[6] vglo2

	{0x8000,12,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//panel timing state control for Sleep in
	{0x9000,15,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//Enmode L-byte of sig1~15 : (pwron_0/pwron_1/pwron_2/pwron_3)
	{0xa000,15,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//Enmode L-byte of sig16~30 : (pwron_0/pwron_1/pwron_2/pwron_3)
	{0xb000,15,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//Enmode L-byte of sig17~40 : (pwron_0/pwron_1/pwron_2/pwron_3)
	{0xc000,15,{0xcb,0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//Enmode L-byte of sig1~15 : (pwro4_0/norm/pwrof_1/pwrof_2)
	{0xd000,15,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x00}},//Enmode H-byte of sig16~30 : (pwro4_0/norm/pwrof_1/pwrof_2)
	{0xe000,15,{0xcb,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x05}},//Enmode H-byte of sig17~40 : (pwro4_0/norm/pwrof_1/pwrof_2)
	{0xf000,12,{0xcb,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},//panel timing state control for LVD

	{0x8000,15,{0xcc,0x03, 0x01, 0x2D, 0x2E, 0x0B, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//panel pad mapping with u2d mode
	{0x9000,15,{0xcc,0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0D, 0x04, 0x02, 0x2D, 0x2E, 0x0C, 0x0A, 0x00}},//panel pad mapping with u2d mode
	{0xA000,15,{0xcc,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E}},//panel pad mapping with u2d mode
	{0xB000,15,{0xcc,0x02, 0x04, 0x2E, 0x2D, 0x0E, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//panel pad mapping with u2d mode
	{0xC000,15,{0xcc,0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x0C, 0x01, 0x03, 0x2E, 0x2D, 0x0D, 0x0F, 0x00}},//panel pad mapping with u2d mode
	{0xD000,15,{0xcc,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x0B}},//panel pad mapping with u2d mode

	{0x8000,13,{0xce,0x8B, 0x03, 0x10, 0x8A, 0x03, 0x10, 0x89, 0x03, 0x10, 0x88, 0x03, 0x10}},//panel timing: GOA VST Setting
	{0x9000,13,{0xce,0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//panel timing: GOA VEND Setting
	{0xA000,15,{0xce,0x38, 0x07, 0x81, 0xDC, 0x8C, 0x16, 0x00, 0x38, 0x06, 0x81, 0xDD, 0x8B, 0x16, 0x00}},//GOA CLKA1,CLKA2 Setting
	{0xB000,15,{0xce,0x38, 0x05, 0x81, 0xDE, 0x8C, 0x16, 0x00, 0x38, 0x04, 0x81, 0xDF, 0x8B, 0x16, 0x00}},//GOA CLKA3,CLKA4 Setting
	{0xC000,15,{0xce,0x38, 0x03, 0x81, 0xE0, 0x8C, 0x16, 0x00, 0x38, 0x02, 0x81, 0xE1, 0x8B, 0x16, 0x00}},//GOA CLKB1,CLKB2 Setting
	{0xD000,15,{0xce,0x38, 0x01, 0x81, 0xE2, 0x8C, 0x16, 0x00, 0x38, 0x00, 0x81, 0xE3, 0x8B, 0x16, 0x00}},//GOA CLKB3,CLKB4 Setting

	{0x8000,15,{0xcf,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//GOA CLKC1,CLKC2 Setting
	{0x9000,15,{0xce,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//GOA CLKC3,CLKC4 Setting
	{0xA000,15,{0xcf,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//GOA CLKD1,CLKD2 Setting
	{0xB000,15,{0xcf,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},//GOA CLKD3,CLKD4 Setting
	{0xC000,12,{0xcf,0x3D, 0x3D, 0x20, 0x20, 0x00, 0x00, 0x01, 0x80, 0x10, 0x03, 0x03}},//GOA ECLK Setting

	{0xB500, 7,{0xc5,0x3F, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF}},//TCON_GOA_OUT Setting
	{0x0000,21,{0xe1,0x08, 0x12, 0x18, 0x25, 0x2E, 0x3A, 0x37, 0x5F, 0x51, 0x6B, 0x98, 0x80, 0x91, 0x5F, 0x47, 0x39, 0x37, 0x29, 0x21, 0x1A}},//Gamma Correction Characteristics Setting (2.2 + )
	{0x0000,21,{0xe2,0x08, 0x12, 0x18, 0x25, 0x2E, 0x3A, 0x37, 0x5F, 0x51, 0x6B, 0x98, 0x80, 0x91, 0x5F, 0x47, 0x39, 0x37, 0x29, 0x21, 0x1A}},//Gamma Correction Characteristics Setting (2.2 - )

	{0x9300, 2,{0xb0,0x8c}},							//cd err sel.
	{0x8800, 2,{0xc4,0x80}},							//80h:Time out SD pull VSS.
	{0x9000, 2,{0xb6,0xb6}},							//sleep out re-load
	{0x9200, 2,{0xb3,0x02}},							//02h:HS auto Disable CMD1
	{0x8100, 2,{0xc4,0x82}},							//SAP : [82h = 0.75uA]
	{0xb200, 2,{0xc5,0xc3}},							//VCL sel.
	{0xc800, 2,{0xb0,0x42}},							//ESD HS.
	{0x9800, 2,{0xc5,0x50}},							//LVD pump set
	{0x9100, 2,{0xc1,0x08}},						//Idle Frame rate / 4
	{0xa400, 3,{0xc5,0x55,0x55}},						//Idle Mode pump freq.

	{0x8000,3,{0xff,0xff,0xff}},						//Disable Access Orise Command 2
	{0x0000,4,{0xff,0xff,0xff,0xff}	}					//Disable Access Command 2 & Software EXTC Enable
};


static struct fb_videomode otm_lcd_modedb[] = {
	{
	 "ORISE-VGA", 60, 640, 480, 37000,
	 100, 100,
	 31, 10,
	 96,4,
	 0,
	 FB_VMODE_NONINTERLACED,
	 0,
	},
};



static struct mipi_lcd_config lcd_config = {
	.virtual_ch		= 0x0,
	.data_lane_num	= OTM1287A_TWO_DATA_LANE,
	.max_phy_clk	= OTM1287A_MAX_DPHY_CLK,
	.dpi_fmt		= MIPI_RGB888,
};

void mipid_otm1287a_get_lcd_videomode(struct fb_videomode **mode,
		struct mipi_lcd_config **data)
{
	*mode = &otm_lcd_modedb[0];
	*data = &lcd_config;
}


static int otm1287a_write_reg(struct mipi_dsi_info *mipi_dsi, u32 reg, u32 data)
{
	int err;
	const u32 buf = reg | (data <<8);
	err = mipi_dsi_pkt_write(mipi_dsi, MIPI_DSI_DCS_SHORT_WRITE_PARAM,
		&buf, 0);
	return err;
}

static int otm1287a_write_cmd(struct mipi_dsi_info *mipi_dsi, const u32 cmd)
{
	int err = mipi_dsi_pkt_write(mipi_dsi, MIPI_DSI_DCS_SHORT_WRITE,
		&cmd, 0);
	mdelay(1);

	return err;
}

int mipid_otm1287a_lcd_setup(struct mipi_dsi_info *mipi_dsi)
{
	int i;

	otm1287a_write_cmd(mipi_dsi,OTM1287A_CMD_SWRESET);
	mdelay(20);

	for(i=0;i<ARRAY_SIZE(lcd_setup);i++)
	{
		mipi_dsi_pkt_write(mipi_dsi, MIPI_DSI_DCS_SHORT_WRITE_PARAM,
				&lcd_setup[i].address_shift, 0);
		if(lcd_setup[i].buf_size == 2)
			mipi_dsi_pkt_write(mipi_dsi, MIPI_DSI_DCS_SHORT_WRITE_PARAM,
					(u32*) lcd_setup[i].buf, 0);
		else
			mipi_dsi_pkt_write(mipi_dsi, MIPI_DSI_DCS_LONG_WRITE,
					(u32*) lcd_setup[i].buf, lcd_setup[i].buf_size);
	}

	otm1287a_write_reg(mipi_dsi, OTM1287A_REG_MADCTL, 0x2);

	otm1287a_write_cmd(mipi_dsi,OTM1287A_CMD_SLPOUT);
	mdelay(120);
	otm1287a_write_cmd(mipi_dsi,OTM1287A_CMD_DISPON);


	return 0;
}

